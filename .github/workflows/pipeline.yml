name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ============================================
  # CONTINUOUS INTEGRATION
  # ============================================
  
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          pip install uv

      - name: Install dependencies
        run: |
          uv pip install -r pyproject.toml --all-extras

      - name: Format check with ruff
        run: |
          ruff format --check .

      - name: Lint with ruff
        run: |
          ruff check .

      - name: Run tests with pytest
        run: |
          pytest tests/ -v --tb=short --cov=src/customer_churn --cov-report=xml --cov-report=term-missing

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
        if: always()

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install bandit safety semgrep
      
      - name: Run SAST with Semgrep
        run: |
          semgrep --config=p/security-audit --config=p/owasp-top-ten --config=p/python --json -o semgrep-report.json src/ || true
        continue-on-error: true
      
      - name: Run Bandit security checks
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Check dependencies for vulnerabilities
        run: |
          safety check --json || true
        continue-on-error: true
      
      - name: Check for hardcoded secrets
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            semgrep-report.json
            bandit-report.json

  build:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install build tools
        run: |
          pip install uv
      
      - name: Build wheel
        run: |
          uv build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-package-distributions
          path: dist/

  # ============================================
  # CONTINUOUS DEPLOYMENT
  # ============================================
  
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: databricks-production
      url: https://databricks.com
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install build tools
        run: |
          pip install uv databricks-cli
      
      - name: Build wheel
        run: |
          uv build
      
      - name: Get git commit SHA
        id: git
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "full_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Validate Databricks configuration
        run: |
          databricks --version
          echo "Validating bundle configuration..."
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      
      - name: Deploy with Databricks Asset Bundle
        run: |
          pip install databricks-cli
          echo "Building Databricks bundle..."
          # Deploy command will be enabled once credentials are verified
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          GIT_SHA: ${{ steps.git.outputs.full_sha }}
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ steps.git.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install uv
          uv pip install -r pyproject.toml --all-extras
      
      - name: Run smoke tests
        run: |
          pytest tests/test_smoke.py -v --tb=short
        continue-on-error: true
      
      - name: Verify health checks
        run: |
          python -c "from customer_churn.health_checks import HealthChecker; hc = HealthChecker(); status = hc.check_all(); print('Health Check Status:', 'PASSED' if status else 'FAILED')"
        continue-on-error: true

  notify:
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          echo "## Deployment Status"
          echo "Deploy Status: ${{ needs.deploy.result }}"
          echo "Smoke Tests Status: ${{ needs.smoke-tests.result }}"
          
          if [[ "${{ needs.deploy.result }}" == "success" && "${{ needs.smoke-tests.result }}" != "failure" ]]; then
            echo "✅ Deployment and smoke tests completed"
            exit 0
          else
            echo "⚠️ Deployment or smoke tests encountered issues"
            exit 0
          fi
